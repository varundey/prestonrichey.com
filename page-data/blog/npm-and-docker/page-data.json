{"componentChunkName":"component---src-templates-post-js","path":"/blog/npm-and-docker/","result":{"data":{"mdx":{"frontmatter":{"title":"Using private NPM packages with Docker onÂ CI","date":"2020-05-25","excerpt":"How a simple npm script failed to run on Docker and what we learned from it"},"code":{"body":"function _typeof(obj) { \"@babel/helpers - typeof\"; if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\nfunction _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) { return call; } return _assertThisInitialized(self); }\n\nfunction _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return self; }\n\nfunction _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function\"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }\n\nfunction _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }\n\nvar layoutProps = {};\n\nvar MDXContent = /*#__PURE__*/function (_React$Component) {\n  _inherits(MDXContent, _React$Component);\n\n  function MDXContent(props) {\n    var _this;\n\n    _classCallCheck(this, MDXContent);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(MDXContent).call(this, props));\n    _this.layout = null;\n    return _this;\n  }\n\n  _createClass(MDXContent, [{\n    key: \"render\",\n    value: function render() {\n      var _this$props = this.props,\n          components = _this$props.components,\n          props = _objectWithoutProperties(_this$props, [\"components\"]);\n\n      return React.createElement(MDXTag, {\n        name: \"wrapper\",\n        components: components\n      }, React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"Our team recently came across a strange issue where one of our application was failing to build after we installed another internal library as a dependency to this app. This was very strange as we were able to get it working on our local machines and the only thing separating the two environments is Docker, which is basically is just a barebone linux container following a set of commands and returning the output build. But the world does not always work as we intend and here we were trying to figure out what was wrong. This post-mortem post details about the issue and what we did to solve it.\"), React.createElement(MDXTag, {\n        name: \"h2\",\n        components: components,\n        props: {\n          \"id\": \"setting-up-the-context\",\n          \"style\": {\n            \"position\": \"relative\"\n          }\n        }\n      }, React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"h2\",\n        props: {\n          \"href\": \"#setting-up-the-context\",\n          \"aria-label\": \"setting up the context permalink\",\n          \"className\": \"anchor before\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"svg\",\n        components: components,\n        parentName: \"a\",\n        props: {\n          \"aria-hidden\": \"true\",\n          \"focusable\": \"false\",\n          \"height\": \"16\",\n          \"version\": \"1.1\",\n          \"viewBox\": \"0 0 16 16\",\n          \"width\": \"16\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"path\",\n        components: components,\n        parentName: \"svg\",\n        props: {\n          \"fillRule\": \"evenodd\",\n          \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n        }\n      }))), \"Setting up the context\"), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"Recently we built an internal JavaScript library which was supposed to power hundreds of other internal applications at Grofers. After building v0.0.1 of this library, we were excited to release it as beta to one of our candidate application. Since we did not intend to publish this library to public just yet and since we were using npm for building our JavaScript apps, we decided to use github for tagging and creating releases. We would then add it as a dependency in package.json of application.\"), React.createElement(MDXTag, {\n        name: \"blockquote\",\n        components: components\n      }, React.createElement(MDXTag, {\n        name: \"p\",\n        components: components,\n        parentName: \"blockquote\"\n      }, \"You can install a npm github package by referencing shorthand \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"author/repo\"), \" in package dependencies.\"), React.createElement(MDXTag, {\n        name: \"div\",\n        components: components,\n        parentName: \"blockquote\",\n        props: {\n          \"className\": \"gatsby-highlight\",\n          \"data-language\": \"json\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"pre\",\n        components: components,\n        parentName: \"div\",\n        props: {\n          \"className\": \"language-json\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"pre\",\n        props: {\n          \"className\": \"language-json\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token property\"\n        }\n      }, \"\\\"dependencies\\\"\"), React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token operator\"\n        }\n      }, \":\"), \" \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \"{\"), \"\\n  \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token property\"\n        }\n      }, \"\\\"react\\\"\"), React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token operator\"\n        }\n      }, \":\"), \" \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token string\"\n        }\n      }, \"\\\"facebook/react#v16.13.1\\\"\"), \"\\n\", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \"}\")))), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components,\n        parentName: \"blockquote\"\n      }, \"This example will \", React.createElement(MDXTag, {\n        name: \"em\",\n        components: components,\n        parentName: \"p\"\n      }, \"try to\"), \" install react version 16.13.1 from \", React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"href\": \"https://github.com/facebook/react/releases/tag/v16.13.1\"\n        }\n      }, \"their releases\"), \". As to why it fails, we will get to that in a bit. You can read more about how npm dependencies work at \", React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"href\": \"https://docs.npmjs.com/files/package.json#dependencies\"\n        }\n      }, \"npm docs\"))), React.createElement(MDXTag, {\n        name: \"h2\",\n        components: components,\n        props: {\n          \"id\": \"librarys-packagejson-structure\",\n          \"style\": {\n            \"position\": \"relative\"\n          }\n        }\n      }, React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"h2\",\n        props: {\n          \"href\": \"#librarys-packagejson-structure\",\n          \"aria-label\": \"librarys packagejson structure permalink\",\n          \"className\": \"anchor before\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"svg\",\n        components: components,\n        parentName: \"a\",\n        props: {\n          \"aria-hidden\": \"true\",\n          \"focusable\": \"false\",\n          \"height\": \"16\",\n          \"version\": \"1.1\",\n          \"viewBox\": \"0 0 16 16\",\n          \"width\": \"16\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"path\",\n        components: components,\n        parentName: \"svg\",\n        props: {\n          \"fillRule\": \"evenodd\",\n          \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n        }\n      }))), \"Library\\u2019s \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"h2\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"package.json\"), \" structure\"), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"But since we were not publishing our library to npm just yet, we changed it\\u2019s \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"package.json\"), \" to build while the client does \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"npm install\"), \". The library\\u2019s package.json looked something like this\"), React.createElement(MDXTag, {\n        name: \"div\",\n        components: components,\n        props: {\n          \"className\": \"gatsby-highlight\",\n          \"data-language\": \"json\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"pre\",\n        components: components,\n        parentName: \"div\",\n        props: {\n          \"className\": \"language-json\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"pre\",\n        props: {\n          \"className\": \"language-json\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \"{\"), \"\\n  ...\\n  \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token property\"\n        }\n      }, \"\\\"files\\\"\"), React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token operator\"\n        }\n      }, \":\"), \" \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \"[\"), \"\\n    \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token string\"\n        }\n      }, \"\\\"dist/*\\\"\"), \"\\n  \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \"]\"), React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \",\"), \"\\n  \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token property\"\n        }\n      }, \"\\\"main\\\"\"), React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token operator\"\n        }\n      }, \":\"), \" \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token string\"\n        }\n      }, \"\\\"dist/index.js\\\"\"), React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \",\"), \"\\n  \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token property\"\n        }\n      }, \"\\\"scripts\\\"\"), React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token operator\"\n        }\n      }, \":\"), \" \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \"{\"), \"\\n    \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token property\"\n        }\n      }, \"\\\"prepare\\\"\"), React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token operator\"\n        }\n      }, \":\"), \" \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token string\"\n        }\n      }, \"\\\"npm run build\\\"\"), \"\\n  \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \"}\"), \"\\n  ...\\n\", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token punctuation\"\n        }\n      }, \"}\")))), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"Let\\u2019s look at what it means:\"), React.createElement(MDXTag, {\n        name: \"ul\",\n        components: components\n      }, React.createElement(MDXTag, {\n        name: \"li\",\n        components: components,\n        parentName: \"ul\"\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"files\"), \": Add the value as entries of the package. In this case, all the files inside \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"dist\"), \" folder\"), React.createElement(MDXTag, {\n        name: \"li\",\n        components: components,\n        parentName: \"ul\"\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"main\"), \": The main entrypoint for the package. In this case, \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"dist/index.js\")), React.createElement(MDXTag, {\n        name: \"li\",\n        components: components,\n        parentName: \"ul\"\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"prepare\"), \": A script invoked by npm which runs before the package is packed, published or issued an \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"npm install\"))), React.createElement(MDXTag, {\n        name: \"blockquote\",\n        components: components\n      }, React.createElement(MDXTag, {\n        name: \"p\",\n        components: components,\n        parentName: \"blockquote\"\n      }, \"There are several other npm scripts like this \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"preinstall\"), \", \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"postInstall\"), \", \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"prepublish\"), \" to name just a few. The reason why React could not be installed from the tag was because it tried to run a script after install as defined in it\\u2019s \", React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"href\": \"https://github.com/facebook/react/blob/v16.13.1/package.json#L108\"\n        }\n      }, \"postInstall script\"), \". Since this postInstall has separate dependencies which you might not have in your local setup, the install throws error. You can read more about them at \", React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"href\": \"https://docs.npmjs.com/misc/scripts#description\"\n        }\n      }, \"npm docs\"))), React.createElement(MDXTag, {\n        name: \"h2\",\n        components: components,\n        props: {\n          \"id\": \"installing-the-dependencies\",\n          \"style\": {\n            \"position\": \"relative\"\n          }\n        }\n      }, React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"h2\",\n        props: {\n          \"href\": \"#installing-the-dependencies\",\n          \"aria-label\": \"installing the dependencies permalink\",\n          \"className\": \"anchor before\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"svg\",\n        components: components,\n        parentName: \"a\",\n        props: {\n          \"aria-hidden\": \"true\",\n          \"focusable\": \"false\",\n          \"height\": \"16\",\n          \"version\": \"1.1\",\n          \"viewBox\": \"0 0 16 16\",\n          \"width\": \"16\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"path\",\n        components: components,\n        parentName: \"svg\",\n        props: {\n          \"fillRule\": \"evenodd\",\n          \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n        }\n      }))), \"Installing the dependencies\"), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"Now we add the library to \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"package.json\"), \" of the client application and run the magical command \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"npm install\"), \". Following things happen after issuing this command:\"), React.createElement(MDXTag, {\n        name: \"ol\",\n        components: components\n      }, React.createElement(MDXTag, {\n        name: \"li\",\n        components: components,\n        parentName: \"ol\"\n      }, \"npm looks at the \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"package.json\"), \" of the library and finds a \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"prepare\"), \" script\"), React.createElement(MDXTag, {\n        name: \"li\",\n        components: components,\n        parentName: \"ol\"\n      }, \"It runs the \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"prepare\"), \" script of library which is \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"npm run build\"), \". So it starts building the library\"), React.createElement(MDXTag, {\n        name: \"li\",\n        components: components,\n        parentName: \"ol\"\n      }, \"It puts the output file of the build i.e. \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"dist/\"), \" into \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"node_modules\"), \" of application\")), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"The directory structure will look something like this:\"), React.createElement(MDXTag, {\n        name: \"div\",\n        components: components,\n        props: {\n          \"className\": \"gatsby-highlight\",\n          \"data-language\": \"text\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"pre\",\n        components: components,\n        parentName: \"div\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"pre\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"Local Machine\\n\\napplication\\n\\u2502-package.json\\n\\u2502-package_lock.json\\n\\u2514\\u2500node_modules\\n  \\u2514\\u2500library\\n    \\u2502-package.json\\n    \\u2514\\u2500dist\\n      |\\u2500 index.js\\n      |\\u2500 <other_source_files>\"))), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"So far so good. We tested our library with the application in our local machines and it all looked ready to \\uD83D\\uDEA2. Our testing environment sits behind a Docker container which consumes the changes, builds the app and serves it over Nginx.\"), React.createElement(MDXTag, {\n        name: \"h2\",\n        components: components,\n        props: {\n          \"id\": \"what-the-dock\",\n          \"style\": {\n            \"position\": \"relative\"\n          }\n        }\n      }, React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"h2\",\n        props: {\n          \"href\": \"#what-the-dock\",\n          \"aria-label\": \"what the dock permalink\",\n          \"className\": \"anchor before\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"svg\",\n        components: components,\n        parentName: \"a\",\n        props: {\n          \"aria-hidden\": \"true\",\n          \"focusable\": \"false\",\n          \"height\": \"16\",\n          \"version\": \"1.1\",\n          \"viewBox\": \"0 0 16 16\",\n          \"width\": \"16\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"path\",\n        components: components,\n        parentName: \"svg\",\n        props: {\n          \"fillRule\": \"evenodd\",\n          \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n        }\n      }))), \"What the Dock?\"), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"After pushing this integration to our CI, we started noticing that the app\\u2019s builds were failing after introducing our library as a dependency to the app which was weird. Since the only thing sitting between the app and the version control was Docker, we started dissecting it. We realised that dist of library inside Docker\\u2019s node_modules was empty\"), React.createElement(MDXTag, {\n        name: \"div\",\n        components: components,\n        props: {\n          \"className\": \"gatsby-highlight\",\n          \"data-language\": \"text\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"pre\",\n        components: components,\n        parentName: \"div\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"pre\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"Docker container\\n\\napplication\\n\\u2502-package.json\\n\\u2502-package_lock.json\\n\\u2514\\u2500node_modules\\n  \\u2514\\u2500library\\n    \\u2502-package.json\\n    \\u2514\\u2500 <no dist?!?>\"))), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"And this was the reason the app could not find the reference to our library and hence it was failing at build.\"), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"Two things were happening here\"), React.createElement(MDXTag, {\n        name: \"ol\",\n        components: components\n      }, React.createElement(MDXTag, {\n        name: \"li\",\n        components: components,\n        parentName: \"ol\"\n      }, \"The clich\\xE9d \\u201CIt works on \", React.createElement(MDXTag, {\n        name: \"del\",\n        components: components,\n        parentName: \"li\"\n      }, \"my\"), \" our machine!\\u201D\"), React.createElement(MDXTag, {\n        name: \"li\",\n        components: components,\n        parentName: \"ol\"\n      }, \"The library was \", React.createElement(MDXTag, {\n        name: \"strong\",\n        components: components,\n        parentName: \"li\"\n      }, \"actually\"), \" getting installed on Docker (since the folder was present) but the \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"li\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"dist/\"), \" folder not showing up!\")), React.createElement(MDXTag, {\n        name: \"h2\",\n        components: components,\n        props: {\n          \"id\": \"come-unsafe-perm\",\n          \"style\": {\n            \"position\": \"relative\"\n          }\n        }\n      }, React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"h2\",\n        props: {\n          \"href\": \"#come-unsafe-perm\",\n          \"aria-label\": \"come unsafe perm permalink\",\n          \"className\": \"anchor before\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"svg\",\n        components: components,\n        parentName: \"a\",\n        props: {\n          \"aria-hidden\": \"true\",\n          \"focusable\": \"false\",\n          \"height\": \"16\",\n          \"version\": \"1.1\",\n          \"viewBox\": \"0 0 16 16\",\n          \"width\": \"16\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"path\",\n        components: components,\n        parentName: \"svg\",\n        props: {\n          \"fillRule\": \"evenodd\",\n          \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n        }\n      }))), \"Come \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"h2\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"unsafe-perm\")), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"Since we could narrow it down to the \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"dist/\"), \" folder not visible, the next obvious assumption was that the build was not running on Docker.\\nAfter several hours of head scratching and brainstorming we came across \", React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"href\": \"https://docs.npmjs.com/misc/config#unsafe-perm\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"a\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"unsafe-perm\")), \". \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"unsafe-perm\"), \" is one of another npm\\u2019s weird script which tries to stop the switching of user and group id while running npm scripts. It is set to \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"true\"), \" when running as non-root user and \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"false\"), \" when running as root. This is probably done so that a package, while installing it\\u2019s dependency does not switch between machine\\u2019s users and groups role and end up running the code as root user which might be vulnerable and hence \\u201Cunsafe\\u201D. Since Docker container runs in \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"sudo\"), \" mode by default, the \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"unsafe-perm\"), \" is false by default. Because of this, application was able to fetch our library but the \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"prepare\"), \" script silently failed to install it.\"), React.createElement(MDXTag, {\n        name: \"h2\",\n        components: components,\n        props: {\n          \"id\": \"the-solution\",\n          \"style\": {\n            \"position\": \"relative\"\n          }\n        }\n      }, React.createElement(MDXTag, {\n        name: \"a\",\n        components: components,\n        parentName: \"h2\",\n        props: {\n          \"href\": \"#the-solution\",\n          \"aria-label\": \"the solution permalink\",\n          \"className\": \"anchor before\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"svg\",\n        components: components,\n        parentName: \"a\",\n        props: {\n          \"aria-hidden\": \"true\",\n          \"focusable\": \"false\",\n          \"height\": \"16\",\n          \"version\": \"1.1\",\n          \"viewBox\": \"0 0 16 16\",\n          \"width\": \"16\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"path\",\n        components: components,\n        parentName: \"svg\",\n        props: {\n          \"fillRule\": \"evenodd\",\n          \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n        }\n      }))), \"The solution\"), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"The temporary solution for us was to set the \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"unsafe-perm\"), \" to \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"true\"), \".\"), React.createElement(MDXTag, {\n        name: \"div\",\n        components: components,\n        props: {\n          \"className\": \"gatsby-highlight\",\n          \"data-language\": \"shell\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"pre\",\n        components: components,\n        parentName: \"div\",\n        props: {\n          \"className\": \"language-shell\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"pre\",\n        props: {\n          \"className\": \"language-shell\"\n        }\n      }, React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token function\"\n        }\n      }, \"npm\"), \" config \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token builtin class-name\"\n        }\n      }, \"set\"), \" unsafe-perm \", React.createElement(MDXTag, {\n        name: \"span\",\n        components: components,\n        parentName: \"code\",\n        props: {\n          \"className\": \"token boolean\"\n        }\n      }, \"true\")))), React.createElement(MDXTag, {\n        name: \"p\",\n        components: components\n      }, \"But ideally the best way is to switch to a non-root user role and then run \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"npm install\"), \" since that way, the outcome will be predictable and would be mimicking your local setup. Each CI service would have it\\u2019s own way of setting the user but Docker does not provide this out of the box. If you are doing something similar, it would be worthwhile to figure out a way to switch user or if that does not work, you can set \", React.createElement(MDXTag, {\n        name: \"code\",\n        components: components,\n        parentName: \"p\",\n        props: {\n          \"className\": \"language-text\"\n        }\n      }, \"unsafe-perm\"), \" in your CI.\"));\n    }\n  }]);\n\n  return MDXContent;\n}(React.Component);\n\nreturn MDXContent;\nMDXContent.isMDXComponent = true;"}}},"pageContext":{"slug":"/blog/npm-and-docker/"}}}