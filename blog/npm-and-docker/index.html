<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.d58a854661ffccf3756e.css" id="gatsby-global-css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.32.8"/><style data-styled="eWXuFb  dZTLiU cxhdwc fkmnfK eJXFLa bSuiGc liQTCq elkVYF fxovqS" data-styled-version="4.4.1">
/* sc-component-id: Nav__StyledNav-sc-10pvdn5-0 */
.eJXFLa{margin-bottom:1em;} @media (min-width:520px){.eJXFLa{margin-bottom:2em;}}
/* sc-component-id: Nav__StyledList-sc-10pvdn5-1 */
.bSuiGc{padding:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin-top:0;} @media (min-width:520px){.bSuiGc{display:block;}}
/* sc-component-id: Nav__ListElement-sc-10pvdn5-2 */
.liQTCq{display:inline-block;padding:0.5em;text-align:center;font-size:1.8rem;} @media (min-width:300px){.liQTCq{font-size:2.2rem;padding-right:0;padding-left:0;}} @media (min-width:350px){.liQTCq{font-size:2.2rem;}} @media (min-width:520px){.liQTCq{padding:0;margin-right:2rem;font-size:2.4rem;}} .liQTCq:after{content:' ';display:none;white-space:pre;} @media (min-width:520px){.liQTCq:after{display:inline-block;}}
/* sc-component-id: Nav__NavItem-sc-10pvdn5-3 */
.elkVYF{color:black;border:none;} .elkVYF:hover{color:blue;} .elkVYF:before{content:'/';display:none;} @media (min-width:520px){.elkVYF:before{display:inline;}} .elkVYF.active{font-weight:bold;}
/* sc-component-id: sc-global-2049630349 */
html{line-height:1.15;-webkit-text-size-adjust:100%;} body{margin:0;} main{display:block;} h1{font-size:2em;margin:0.67em 0;} hr{box-sizing:content-box;height:0;overflow:visible;} pre{font-family:monospace,monospace;font-size:1em;} a{background-color:transparent;} abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;} b,strong{font-weight:bolder;} code,kbd,samp{font-family:monospace,monospace;font-size:1em;} small{font-size:80%;} sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;} sub{bottom:-0.25em;} sup{top:-0.5em;} img{border-style:none;} button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;} button,input{overflow:visible;} button,select{text-transform:none;} button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button;} button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;} button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;} fieldset{padding:0.35em 0.75em 0.625em;} legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;} progress{vertical-align:baseline;} textarea{overflow:auto;} [type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;} [type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;} [type="search"]{-webkit-appearance:textfield;outline-offset:-2px;} [type="search"]::-webkit-search-decoration{-webkit-appearance:none;} ::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;} details{display:block;} summary{display:list-item;} template{display:none;} [hidden]{display:none;} html,body{height:100%;} html{box-sizing:border-box;font-size:62.5%;} body{font-size:16px;font-size:1.6rem;font-family:'Roboto Mono',monospace;word-break:break-word;} h1,h2,h3,h4,h5,h6{font-family:'Rubik',sans-serif;margin:0.5em 0;} *,*:before,*:after{box-sizing:inherit;} iframe{margin:0 auto;display:block;max-width:100%;width:100%;} iframe.youtube{height:20rem;} @media (min-width:550px){iframe.youtube{height:34rem;}} blockquote{margin-left:1em;margin-right:1em;} @media (min-width:520px){blockquote{margin-left:2em;margin-right:2em;}} figure{margin:0;} ul{padding:0;list-style:square;} a{-webkit-text-decoration:none;text-decoration:none;color:blue;border-bottom:2px solid transparent;} a:hover{color:#999;border-color:#999;} a.anchor{border:none;} p{line-height:1.5em;font-size:1.8rem;} twitterwidget{margin:0 auto;} .sidebar{margin-left:auto;margin-right:auto;} @media (min-width:520px){.sidebar{width:calc(50% + 1em);clear:both;float:right;padding-left:1em;}} .sidebar.left{float:left;padding-left:0;padding-right:1em;} .sidebar img{width:100%;} .blog-full,.blog-inset{margin-left:auto;margin-right:auto;width:100%;} .blog-full img,.blog-inset img{width:100%;} @media (min-width:520px){.blog-inset{margin-top:2em;margin-bottom:2em;width:80%;}} .blog-section{font-size:1.8rem;} .blog-section:not(:first-child){margin-top:2em;} .blog-section h1,.blog-section h2,.blog-section h3,.blog-section h4,.blog-section h5,.blog-section h6{margin-bottom:0.5em;} .blog-section h1 + p,.blog-section h2 + p,.blog-section h3 + p,.blog-section h4 + p,.blog-section h5 + p,.blog-section h6 + p{margin-top:0.5em;} .blog-section ul{margin-left:1.5em;} @media (min-width:520px){.blog-section ul{margin-left:2.5em;}} .blog-section li{margin:0.5em 0;line-height:1.5em;} .blog-section li p{margin:0;} :not(pre) > code[class*="language-"],pre[class*="language-"]{font-size:0.9em;} .gatsby-highlight-code-line{background-color:#feb;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #f99;} @media (min-width:520px){.gatsby-resp-image-wrapper{margin-top:2em;margin-bottom:2em;width:80%;}}
/* sc-component-id: Layout__Main-p46nka-0 */
.eWXuFb{max-width:83rem;padding:1em 1em 2em;margin:0 auto;} @media (min-width:350px){.eWXuFb{padding:1em 1.5em 4em;}} @media (min-width:520px){.eWXuFb{padding:2rem 2em 6rem;}}
/* sc-component-id: Layout__StyledTitle-p46nka-2 */
.cxhdwc{margin:0.3em 0;} @media (min-width:350px){.cxhdwc{margin:0.5em 0 0.2em;}} @media (min-width:520px){.cxhdwc{margin:0.667em 0;}}
/* sc-component-id: Layout__TitleLink-p46nka-3 */
.fkmnfK{text-transform:lowercase;color:#000;-webkit-text-decoration:none;text-decoration:none;border:none;} .fkmnfK:hover{color:#0000ff;}
/* sc-component-id: post__StyledPostDate-sd6zd6-0 */
.fxovqS{color:#999;font-weight:400;display:block;margin-top:1em;margin-bottom:1em;text-align:right;}</style><title data-react-helmet="true">Varun Dey | Using private NPM packages with Docker on CI</title><link data-react-helmet="true" rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link data-react-helmet="true" rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link data-react-helmet="true" rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link data-react-helmet="true" rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/><link data-react-helmet="true" rel="manifest" href="/manifest.json"/><link data-react-helmet="true" rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,700|Rubik:700" rel="stylesheet"/><meta data-react-helmet="true" name="theme-color" content="#ffffff"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:url" content="https://varundey.me"/><meta data-react-helmet="true" property="og:image" content="https://varundey.me/social-meta.png"/><meta data-react-helmet="true" property="og:image:secure_url" content="https://varundey.me/social-meta.png"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:image" content="https://varundey.me/social-meta.png"/><meta data-react-helmet="true" name="twitter:creator" content="@AsDeyQuote"/><meta data-react-helmet="true" property="og:title" content="Using private NPM packages with Docker on CI"/><meta data-react-helmet="true" name="twitter:title" content="Using private NPM packages with Docker on CI"/><meta data-react-helmet="true" property="og:description" content="How a simple npm script failed to run on Docker and what we learned from it"/><meta data-react-helmet="true" name="twitter:description" content="How a simple npm script failed to run on Docker and what we learned from it"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/webpack-runtime-563e0dda3d1db9297f49.js"/><link as="script" rel="preload" href="/framework-66de6f443629588fba4e.js"/><link as="script" rel="preload" href="/app-f7a70bf7fd82d1d79cb8.js"/><link as="script" rel="preload" href="/styles-e9d24b1846c7d6eb9685.js"/><link as="script" rel="preload" href="/commons-998a45413050fa67cc9d.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-21e77733483d85b92cab.js"/><link as="fetch" rel="preload" href="/page-data/blog/npm-and-docker/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><main class="Layout__Main-p46nka-0 eWXuFb"><header class="Layout__StyledHeader-p46nka-1 dZTLiU"><h1 class="Layout__StyledTitle-p46nka-2 cxhdwc"><a class="Layout__TitleLink-p46nka-3 fkmnfK" href="/">Varun Dey</a></h1><nav class="Nav__StyledNav-sc-10pvdn5-0 eJXFLa"><ul class="Nav__StyledList-sc-10pvdn5-1 bSuiGc"><li class="Nav__ListElement-sc-10pvdn5-2 liQTCq"><a class="Nav__NavItem-sc-10pvdn5-3 elkVYF" href="/blog/">blog</a></li><li class="Nav__ListElement-sc-10pvdn5-2 liQTCq"><a class="Nav__NavItem-sc-10pvdn5-3 elkVYF" href="/projects/">projects</a></li><li class="Nav__ListElement-sc-10pvdn5-2 liQTCq"><a class="Nav__NavItem-sc-10pvdn5-3 elkVYF" href="/talks/">talks</a></li></ul></nav></header><h1>Using private NPM packages with Docker on CI</h1><p>Our team recently came across a strange issue where one of our application was failing to build after we installed another internal library as a dependency to this app. This was very strange as we were able to get it working on our local machines and the only thing separating the two environments is Docker, which is basically is just a barebone linux container following a set of commands and returning the output build. But the world does not always work as we intend and here we were trying to figure out what was wrong. This post-mortem post details about the issue and what we did to solve it.</p><h2 id="setting-up-the-context" style="position:relative"><a href="#setting-up-the-context" aria-label="setting up the context permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up the context</h2><p>Recently we built an internal JavaScript library which was supposed to power hundreds of other internal applications at Grofers. After building v0.0.1 of this library, we were excited to release it as beta to one of our candidate application. Since we did not intend to publish this library to public just yet and since we were using npm for building our JavaScript apps, we decided to use github for tagging and creating releases. We would then add it as a dependency in package.json of application.</p><blockquote><p>You can install a npm github package by referencing shorthand <code class="language-text">author/repo</code> in package dependencies.</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;facebook/react#v16.13.1&quot;</span>
<span class="token punctuation">}</span></code></pre></div><p>This example will <em>try to</em> install react version 16.13.1 from <a href="https://github.com/facebook/react/releases/tag/v16.13.1">their releases</a>. As to why it fails, we will get to that in a bit. You can read more about how npm dependencies work at <a href="https://docs.npmjs.com/files/package.json#dependencies">npm docs</a></p></blockquote><h2 id="librarys-packagejson-structure" style="position:relative"><a href="#librarys-packagejson-structure" aria-label="librarys packagejson structure permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Library’s <code class="language-text">package.json</code> structure</h2><p>But since we were not publishing our library to npm just yet, we changed it’s <code class="language-text">package.json</code> to build while the client does <code class="language-text">npm install</code>. The library’s package.json looked something like this</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  ...
  <span class="token property">&quot;files&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;dist/*&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;prepare&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build&quot;</span>
  <span class="token punctuation">}</span>
  ...
<span class="token punctuation">}</span></code></pre></div><p>Let’s look at what it means:</p><ul><li><code class="language-text">files</code>: Add the value as entries of the package. In this case, all the files inside <code class="language-text">dist</code> folder</li><li><code class="language-text">main</code>: The main entrypoint for the package. In this case, <code class="language-text">dist/index.js</code></li><li><code class="language-text">prepare</code>: A script invoked by npm which runs before the package is packed, published or issued an <code class="language-text">npm install</code></li></ul><blockquote><p>There are several other npm scripts like this <code class="language-text">preinstall</code>, <code class="language-text">postInstall</code>, <code class="language-text">prepublish</code> to name just a few. The reason why React could not be installed from the tag was because it tried to run a script after install as defined in it’s <a href="https://github.com/facebook/react/blob/v16.13.1/package.json#L108">postInstall script</a>. Since this postInstall has separate dependencies which you might not have in your local setup, the install throws error. You can read more about them at <a href="https://docs.npmjs.com/misc/scripts#description">npm docs</a></p></blockquote><h2 id="installing-the-dependencies" style="position:relative"><a href="#installing-the-dependencies" aria-label="installing the dependencies permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installing the dependencies</h2><p>Now we add the library to <code class="language-text">package.json</code> of the client application and run the magical command <code class="language-text">npm install</code>. Following things happen after issuing this command:</p><ol><li>npm looks at the <code class="language-text">package.json</code> of the library and finds a <code class="language-text">prepare</code> script</li><li>It runs the <code class="language-text">prepare</code> script of library which is <code class="language-text">npm run build</code>. So it starts building the library</li><li>It puts the output file of the build i.e. <code class="language-text">dist/</code> into <code class="language-text">node_modules</code> of application</li></ol><p>The directory structure will look something like this:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Local Machine

application
│-package.json
│-package_lock.json
└─node_modules
  └─library
    │-package.json
    └─dist
      |─ index.js
      |─ &lt;other_source_files&gt;</code></pre></div><p>So far so good. We tested our library with the application in our local machines and it all looked ready to 🚢. Our testing environment sits behind a Docker container which consumes the changes, builds the app and serves it over Nginx.</p><h2 id="what-the-dock" style="position:relative"><a href="#what-the-dock" aria-label="what the dock permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What the Dock?</h2><p>After pushing this integration to our CI, we started noticing that the app’s builds were failing after introducing our library as a dependency to the app which was weird. Since the only thing sitting between the app and the version control was Docker, we started dissecting it. We realised that dist of library inside Docker’s node_modules was empty</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Docker container

application
│-package.json
│-package_lock.json
└─node_modules
  └─library
    │-package.json
    └─ &lt;no dist?!?&gt;</code></pre></div><p>And this was the reason the app could not find the reference to our library and hence it was failing at build.</p><p>Two things were happening here</p><ol><li>The clichéd “It works on <del>my</del> our machine!”</li><li>The library was <strong>actually</strong> getting installed on Docker (since the folder was present) but the <code class="language-text">dist/</code> folder not showing up!</li></ol><h2 id="come-unsafe-perm" style="position:relative"><a href="#come-unsafe-perm" aria-label="come unsafe perm permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Come <code class="language-text">unsafe-perm</code></h2><p>Since we could narrow it down to the <code class="language-text">dist/</code> folder not visible, the next obvious assumption was that the build was not running on Docker.
After several hours of head scratching and brainstorming we came across <a href="https://docs.npmjs.com/misc/config#unsafe-perm"><code class="language-text">unsafe-perm</code></a>. <code class="language-text">unsafe-perm</code> is one of another npm’s weird script which tries to stop the switching of user and group id while running npm scripts. It is set to <code class="language-text">true</code> when running as non-root user and <code class="language-text">false</code> when running as root. This is probably done so that a package, while installing it’s dependency does not switch between machine’s users and groups role and end up running the code as root user which might be vulnerable and hence “unsafe”. Since Docker container runs in <code class="language-text">sudo</code> mode by default, the <code class="language-text">unsafe-perm</code> is false by default. Because of this, application was able to fetch our library but the <code class="language-text">prepare</code> script silently failed to install it.</p><h2 id="the-solution" style="position:relative"><a href="#the-solution" aria-label="the solution permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The solution</h2><p>The temporary solution for us was to set the <code class="language-text">unsafe-perm</code> to <code class="language-text">true</code>.</p><div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> config <span class="token builtin class-name">set</span> unsafe-perm <span class="token boolean">true</span></code></pre></div><p>But ideally the best way is to switch to a non-root user role and then run <code class="language-text">npm install</code> since that way, the outcome will be predictable and would be mimicking your local setup. Each CI service would have it’s own way of setting the user but Docker does not provide this out of the box. If you are doing something similar, it would be worthwhile to figure out a way to switch user or if that does not work, you can set <code class="language-text">unsafe-perm</code> in your CI.</p><p>This article is also posted on <a href="https://lambda.grofers.com/how-to-use-your-private-npm-packages-with-docker-on-ci-ccc7c2d019d6">lambda</a> - the official engineering blog of Grofers.   </p><time class="post__StyledPostDate-sd6zd6-0 fxovqS">2020-05-25</time></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-72524139-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/npm-and-docker/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-d47b21a5737d9524fa70.js"],"app":["/app-f7a70bf7fd82d1d79cb8.js"],"component---src-pages-404-mdx":["/component---src-pages-404-mdx-c8ddbedd0e39578f272a.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-60e08719a0cef1c893ad.js"],"component---src-pages-index-mdx":["/component---src-pages-index-mdx-5cfef76f1c65bf97eaac.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-f23c4813ca7f21b962f1.js"],"component---src-pages-talks-js":["/component---src-pages-talks-js-67eb64b6a933950dcbec.js"],"component---src-templates-post-js":["/component---src-templates-post-js-21e77733483d85b92cab.js"],"component---src-templates-project-js":["/component---src-templates-project-js-0bbece202eb8c3642a37.js"]};/*]]>*/</script><script src="/polyfill-d47b21a5737d9524fa70.js" nomodule=""></script><script src="/component---src-templates-post-js-21e77733483d85b92cab.js" async=""></script><script src="/commons-998a45413050fa67cc9d.js" async=""></script><script src="/styles-e9d24b1846c7d6eb9685.js" async=""></script><script src="/app-f7a70bf7fd82d1d79cb8.js" async=""></script><script src="/framework-66de6f443629588fba4e.js" async=""></script><script src="/webpack-runtime-563e0dda3d1db9297f49.js" async=""></script></body></html>